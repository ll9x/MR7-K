<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لعبة الثعبان والسلم - أونلاين</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f0f8ff;
            margin: 0;
            padding: 20px;
        }
        .welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
            text-align: center;
        }
        .welcome-title {
            font-size: 4em;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .name-input-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
            text-align: center;
        }
        .input-container {
            background: rgba(255,255,255,0.1);
            padding: 40px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            min-width: 300px;
        }
        .input-group {
            margin: 20px 0;
            text-align: right;
        }
        .input-group label {
            display: block;
            margin-bottom: 10px;
            font-size: 1.2em;
            font-weight: bold;
        }
        .input-group input {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            background: rgba(255,255,255,0.9);
            color: #333;
            text-align: center;
        }
        .join-button {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.3em;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
            margin-top: 20px;
        }
        .game-content {
            display: none;
        }
        #game-container {
            display: inline-block;
            margin: 20px auto;
            position: relative;
            width: 600px;
            height: 600px;
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.2);
            overflow: hidden;
            margin-bottom: 20px;
        }
        #board {
            width: 100%;
            height: 100%;
            border-collapse: collapse;
            border-spacing: 0;
            position: relative;
        }
        #board td {
            position: relative;
            padding: 0;
            margin: 0;
            width: 10%;
            height: 10%;
            box-sizing: border-box;
        }
        .player {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin: 0 auto;
            position: absolute;
            z-index: 10;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
            transition: all 0.5s ease-in-out;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }
        .player1 {
            background-color: #e74c3c;
        }
        .player2 {
            background-color: #1b9ef5;
        }
        #controls {
            margin: 20px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #0943cb;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        #status {
            margin: 15px;
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            min-height: 60px;
        }
        #dice {
            font-size: 28px;
            margin: 15px;
            padding: 15px;
            background-color: white;
            border: 2px solid #ddd;
            display: inline-block;
            width: 60px;
            border-radius: 10px;
        }
        
        /* تحسينات للاستجابة */
        @media (min-width: 769px) and (max-width: 1024px) {
            /* الأجهزة اللوحية */
            .welcome-title {
                font-size: 3.5em;
            }
            
            .welcome-subtitle {
                font-size: 1.3em;
            }
            
            .welcome-features {
                gap: 25px;
                margin: 30px 0;
            }
            
            .feature-card {
                min-width: 180px;
                padding: 18px;
            }
            
            .start-button {
                padding: 14px 35px;
                font-size: 1.2em;
            }
            
            #game-container {
                width: 70vw;
                height: 70vw;
                max-width: 500px;
                max-height: 500px;
            }
            
            .cell {
                font-size: 10px;
                padding: 2px;
            }
            
            .player {
                width: 16px;
                height: 16px;
                border-radius: 8px;
            }
            
            #controls {
                flex-direction: row;
                justify-content: center;
                gap: 15px;
                flex-wrap: wrap;
            }
            
            #controls button {
                padding: 10px 20px;
                font-size: 16px;
            }
        }
        
        @media (min-width: 1025px) {
            /* أجهزة الكمبيوتر */
            .welcome-screen {
                padding: 20px;
            }
            
            .welcome-features {
                max-width: 800px;
            }
            
            #game-container {
                width: 60vw;
                height: 60vw;
                max-width: 600px;
                max-height: 600px;
            }
        }
        
        /* تحسينات عامة للاستجابة */
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        
        .welcome-screen {
            padding: 20px;
            min-height: 100vh;
        }
        
        #game-container {
            position: relative;
            margin: 0 auto;
        }
        
        #controls {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        #controls button {
            white-space: nowrap;
            min-width: 120px;
        }
    </style>
</head>
<body>
    <!-- واجهة الترحيب -->
    <div id="welcomeScreen" class="welcome-screen">
        <div class="welcome-title">Snake MR7</div>
        <div class="welcome-title">🎲Snake MR7🎲</div>
        <div style="color: rgb(219, 241, 20); font-size: 1.5em; margin-bottom: 30px;">Mostafa Alrawi</div>
        <button class="join-button" onclick="showNameInput()">🎮 ابدأ اللعب أونلاين 🎮</button>
    </div>
    
    <!-- واجهة إدخال الاسم والغرفة -->
    <div id="nameInputScreen" class="name-input-screen">
        <div class="input-container">
            <h2>🎮 انضم إلى غرفة اللعب</h2>
            
            <div class="input-group">
                <label for="playerName">اسم اللاعب:</label>
                <input type="text" id="playerName" placeholder="أدخل اسمك هنا..." maxlength="20">
            </div>
            
            <div class="input-group">
                <label for="roomId">رقم الغرفة:</label>
                <input type="text" id="roomId" placeholder="أدخل رقم الغرفة..." maxlength="10">
            </div>
            
            <button class="join-button" onclick="joinRoom()">انضم إلى الغرفة</button>
            
            <div style="margin-top: 20px; font-size: 0.9em; opacity: 0.8;">
                💡 نصيحة: شارك رقم الغرفة مع صديقك للعب معاً
            </div>
        </div>
    </div>
    
    <!-- محتوى اللعبة -->
    <div id="gameContent" class="game-content">
        <div id="game-container">
            <table id="board"></table>
            <div id="player1" class="player player1"></div>
            <div id="player2" class="player player2"></div>
        </div>
        <div id="controls">
            <div id="status">في انتظار انضمام اللاعب الثاني...</div>
            <div id="dice">-</div>
            <button id="roll">إرم النرد</button>
            <button id="reset">لعبة جديدة</button>
            <button onclick="showWelcome()" style="background: #e74c3c;">عودة للقائمة</button>
        </div>
    </div>

    <script>
        // إعداد Socket.IO
        const socket = io();
        
        // متغيرات اللعبة
        let currentPlayer = 1;
        let playerPositions = [1, 1];
        let gameOver = false;
        let myPlayerNumber = null;
        let myPlayerName = '';
        let roomId = '';
        let players = [];
        // متغيرات منطق اللوحة
        let snakes = [];
        let ladders = [];
        let negativeSquares = [];
        let positiveSquares = [];
        let isMoving = false;
        const ROWS = 10;
        const COLS = 10;
        const TOTAL_CELLS = ROWS * COLS;
        const MIN_SNAKES = 5;
        const MAX_SNAKES = 8;
        const MIN_LADDERS = 5;
        const MAX_LADDERS = 8;
        const MOVE_DELAY = 300; // تأخير الحركة بين الخلايا (بالمللي ثانية)

        // --- دوال توليد ورسم اللوحة ---
        function generateSnakesAndLadders() {
            snakes = [];
            ladders = [];
            negativeSquares = [];
            positiveSquares = [];
            // إزالة أي رسومات قديمة
            document.querySelectorAll('.connection, .connection-label, .negative-square, .positive-square').forEach(el => el.remove());
            // توليد السلالم (خطوط خضراء)
            const numLadders = getRandomInt(MIN_LADDERS, MAX_LADDERS);
            for (let i = 0; i < numLadders; i++) {
                let start, end;
                do {
                    start = getRandomInt(2, TOTAL_CELLS - 10);
                    end = getRandomInt(start + 5, Math.min(start + 20, TOTAL_CELLS));
                } while (ladders.some(l => l.start === start || l.end === end || Math.abs(l.start - start) < 5));
                ladders.push({start, end});
                drawConnection(start, end, 'ladder');
            }
            // توليد الثعابين (خطوط حمراء)
            const numSnakes = getRandomInt(MIN_SNAKES, MAX_SNAKES);
            for (let i = 0; i < numSnakes; i++) {
                let start, end;
                do {
                    start = getRandomInt(10, TOTAL_CELLS);
                    end = getRandomInt(1, start - 5);
                } while (snakes.some(s => s.start === start || s.end === end || Math.abs(s.start - start) < 5));
                snakes.push({start, end});
                drawConnection(start, end, 'snake');
            }
            // توليد المربعات السالبة (ترجع الخصم)
            const numNegativeSquares = getRandomInt(3, 6);
            for (let i = 0; i < numNegativeSquares; i++) {
                let position, negativeValue;
                do {
                    position = getRandomInt(10, TOTAL_CELLS - 10);
                    negativeValue = getRandomInt(1, 6);
                } while (
                    negativeSquares.some(ns => ns.position === position) ||
                    snakes.some(s => s.start === position || s.end === position) ||
                    ladders.some(l => l.start === position || l.end === position)
                );
                negativeSquares.push({position, value: negativeValue});
                markNegativeSquare(position, negativeValue);
            }
            // توليد المربعات الموجبة (تقدم اللاعب)
            const numPositiveSquares = getRandomInt(3, 6);
            for (let i = 0; i < numPositiveSquares; i++) {
                let position, positiveValue;
                do {
                    position = getRandomInt(10, TOTAL_CELLS - 10);
                    positiveValue = getRandomInt(1, 6);
                } while (
                    positiveSquares.some(ps => ps.position === position) ||
                    negativeSquares.some(ns => ns.position === position) ||
                    snakes.some(s => s.start === position || s.end === position) ||
                    ladders.some(l => l.start === position || l.end === position)
                );
                positiveSquares.push({position, value: positiveValue});
                markPositiveSquare(position, positiveValue);
            }
        }

        function drawConnection(start, end, type) {
            const startCell = document.getElementById(`cell-${start}`);
            const endCell = document.getElementById(`cell-${end}`);
            if (!startCell || !endCell) return;
            // استخدم offsetLeft/offsetTop النسبية للحاوية
            const boardRect = board.getBoundingClientRect();
            const containerRect = document.getElementById('game-container').getBoundingClientRect();
            const startX = startCell.offsetLeft + startCell.offsetWidth / 2;
            const startY = startCell.offsetTop + startCell.offsetHeight / 2;
            const endX = endCell.offsetLeft + endCell.offsetWidth / 2;
            const endY = endCell.offsetTop + endCell.offsetHeight / 2;
            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.classList.add('connection', type);
            svg.setAttribute('width', Math.abs(endX - startX) + 10);
            svg.setAttribute('height', Math.abs(endY - startY) + 10);
            svg.style.position = 'absolute';
            svg.style.left = `${Math.min(startX, endX) - 5}px`;
            svg.style.top = `${Math.min(startY, endY) - 5}px`;
            svg.style.pointerEvents = 'none';
            svg.style.zIndex = 1;
            const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
            line.setAttribute('x1', startX < endX ? 5 : Math.abs(endX - startX) + 5);
            line.setAttribute('y1', startY < endY ? 5 : Math.abs(endY - startY) + 5);
            line.setAttribute('x2', startX < endX ? Math.abs(endX - startX) + 5 : 5);
            line.setAttribute('y2', startY < endY ? Math.abs(endY - startY) + 5 : 5);
            line.setAttribute('stroke', type === 'ladder' ? '#2ecc71' : '#e74c3c');
            line.setAttribute('stroke-width', '3');
            line.setAttribute('stroke-linecap', 'round');
            svg.appendChild(line);
            document.getElementById('game-container').appendChild(svg);
            // إضافة نص
            const label = document.createElement('div');
            label.classList.add('connection-label', `${type}-label`);
            label.textContent = `${start}→${end}`;
            label.style.position = 'absolute';
            label.style.left = `${Math.min(startX, endX) + Math.abs(endX - startX)/2 - 15}px`;
            label.style.top = `${Math.min(startY, endY) + Math.abs(endY - startY)/2 - 10}px`;
            label.style.backgroundColor = 'white';
            label.style.padding = '2px 5px';
            label.style.borderRadius = '3px';
            label.style.fontSize = '10px';
            label.style.fontWeight = 'bold';
            label.style.zIndex = 5;
            label.style.boxShadow = '0 0 3px rgba(0,0,0,0.2)';
            label.style.color = type === 'ladder' ? '#27ae60' : '#c0392b';
            label.style.border = type === 'ladder' ? '1px solid #27ae60' : '1px solid #c0392b';
            document.getElementById('game-container').appendChild(label);
        }

        function markNegativeSquare(position, value) {
            const cell = document.getElementById(`cell-${position}`);
            if (!cell) return;
            const negativeMarker = document.createElement('div');
            negativeMarker.classList.add('negative-square');
            negativeMarker.textContent = `-${value}`;
            negativeMarker.style.position = 'absolute';
            negativeMarker.style.top = '2px';
            negativeMarker.style.right = '2px';
            negativeMarker.style.background = '#ff4757';
            negativeMarker.style.color = 'white';
            negativeMarker.style.fontSize = '10px';
            negativeMarker.style.fontWeight = 'bold';
            negativeMarker.style.padding = '2px 4px';
            negativeMarker.style.borderRadius = '3px';
            negativeMarker.style.minWidth = '15px';
            negativeMarker.style.textAlign = 'center';
            negativeMarker.style.boxShadow = '0 1px 3px rgba(0,0,0,0.3)';
            negativeMarker.style.zIndex = '5';
            cell.style.backgroundColor = '#ffebee';
            cell.style.border = '2px solid #ff4757';
            cell.appendChild(negativeMarker);
        }

        function markPositiveSquare(position, value) {
            const cell = document.getElementById(`cell-${position}`);
            if (!cell) return;
            const positiveMarker = document.createElement('div');
            positiveMarker.classList.add('positive-square');
            positiveMarker.textContent = `+${value}`;
            positiveMarker.style.position = 'absolute';
            positiveMarker.style.top = '2px';
            positiveMarker.style.left = '2px';
            positiveMarker.style.background = '#2ecc71';
            positiveMarker.style.color = 'white';
            positiveMarker.style.fontSize = '10px';
            positiveMarker.style.fontWeight = 'bold';
            positiveMarker.style.padding = '2px 4px';
            positiveMarker.style.borderRadius = '3px';
            positiveMarker.style.minWidth = '15px';
            positiveMarker.style.textAlign = 'center';
            positiveMarker.style.boxShadow = '0 1px 3px rgba(0,0,0,0.3)';
            positiveMarker.style.zIndex = '5';
            cell.style.backgroundColor = '#e8f5e8';
            cell.style.border = '2px solid #2ecc71';
            cell.appendChild(positiveMarker);
        }

        // --- دوال مساعدة ---
        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        // --- حركة اللاعبين (أنيميشن) ---
        async function movePlayerSmoothly(player, targetPosition) {
            isMoving = true;
            rollButton.disabled = true;
            const playerElement = player === 1 ? player1Element : player2Element;
            const targetCell = document.getElementById(`cell-${targetPosition}`);
            // استخدم offsetLeft/offsetTop بدلاً من getBoundingClientRect
            const targetX = targetCell.offsetLeft + targetCell.offsetWidth / 2 - playerElement.offsetWidth / 2;
            const targetY = targetCell.offsetTop + targetCell.offsetHeight / 2 - playerElement.offsetHeight / 2;
            playerElement.style.left = `${targetX}px`;
            playerElement.style.top = `${targetY}px`;
            await new Promise(resolve => {
                playerElement.addEventListener('transitionend', resolve, { once: true });
            });
            playerPositions[player-1] = targetPosition;
            isMoving = false;
            rollButton.disabled = false;
        }

        async function movePlayerStepByStep(player, steps) {
            isMoving = true;
            rollButton.disabled = true;
            const playerElement = player === 1 ? player1Element : player2Element;
            let currentPos = playerPositions[player-1];
            const stepsToWin = TOTAL_CELLS - currentPos;
            let targetPosition;
            if (currentPos + steps > TOTAL_CELLS) {
                targetPosition = currentPos;
                statusElement.textContent = `اللاعب ${player} يحتاج ${stepsToWin} بالضبط للفوز! (رمى ${steps})`;
                await new Promise(resolve => setTimeout(resolve, 1500));
            } else {
                targetPosition = currentPos + steps;
            }
            for (let pos = currentPos + 1; pos <= targetPosition; pos++) {
                const targetCell = document.getElementById(`cell-${pos}`);
                const targetRect = targetCell.getBoundingClientRect();
                const boardRect = board.getBoundingClientRect();
                const targetX = targetRect.left - boardRect.left + targetRect.width / 2;
                const targetY = targetRect.top - boardRect.top + targetRect.height / 2;
                playerElement.style.left = `${targetX}px`;
                playerElement.style.top = `${targetY}px`;
                await new Promise(resolve => setTimeout(resolve, MOVE_DELAY));
                currentPos = pos;
            }
            playerPositions[player-1] = targetPosition;
            isMoving = false;
            rollButton.disabled = false;
            return targetPosition;
        }

        // --- التأثيرات الخاصة ---
        function checkSnakeOrLadder(position) {
            for (const ladder of ladders) {
                if (ladder.start === position) {
                    return {type: 'ladder', to: ladder.end};
                }
            }
            for (const snake of snakes) {
                if (snake.start === position) {
                    return {type: 'snake', to: snake.end};
                }
            }
            return null;
        }

        function checkNegativeSquare(position) {
            for (const negSquare of negativeSquares) {
                if (negSquare.position === position) {
                    return {value: negSquare.value};
                }
            }
            return null;
        }

        function checkPositiveSquare(position) {
            for (const posSquare of positiveSquares) {
                if (posSquare.position === position) {
                    return {value: posSquare.value};
                }
            }
            return null;
        }

        async function processSpecialEffects(player, position, depth = 0) {
            if (depth > 5) return position;
            let currentPosition = position;
            let hasEffect = false;
            const snakeOrLadder = checkSnakeOrLadder(currentPosition);
            if (snakeOrLadder) {
                const message = snakeOrLadder.type === 'ladder' ? 
                    `🚀 اللاعب ${player} صعد بسلم من ${currentPosition} إلى ${snakeOrLadder.to}!` : 
                    `🐍 اللاعب ${player} انزلق بثعبان من ${currentPosition} إلى ${snakeOrLadder.to}!`;
                statusElement.textContent = message;
                await new Promise(resolve => setTimeout(resolve, 1000));
                await movePlayerSmoothly(player, snakeOrLadder.to);
                currentPosition = snakeOrLadder.to;
                hasEffect = true;
            }
            if (hasEffect) {
                return await processSpecialEffects(player, currentPosition, depth + 1);
            }
            return currentPosition;
        }
        
        // عناصر DOM
        const board = document.getElementById('board');
        const statusElement = document.getElementById('status');
        const diceElement = document.getElementById('dice');
        const rollButton = document.getElementById('roll');
        const resetButton = document.getElementById('reset');
        const player1Element = document.getElementById('player1');
        const player2Element = document.getElementById('player2');
        
        // دوال واجهة الترحيب
        function showNameInput() {
            const welcomeScreen = document.getElementById('welcomeScreen');
            const nameInputScreen = document.getElementById('nameInputScreen');
            
            welcomeScreen.style.display = 'none';
            nameInputScreen.style.display = 'flex';
        }
        
        function showWelcome() {
            const welcomeScreen = document.getElementById('welcomeScreen');
            const gameContent = document.getElementById('gameContent');
            const nameInputScreen = document.getElementById('nameInputScreen');
            
            gameContent.style.display = 'none';
            nameInputScreen.style.display = 'none';
            welcomeScreen.style.display = 'flex';
            
            // قطع الاتصال بالخادم
            socket.disconnect();
        }
        
        // دالة الانضمام إلى الغرفة
        function joinRoom() {
            const playerName = document.getElementById('playerName').value.trim();
            const roomIdInput = document.getElementById('roomId').value.trim();
            
            if (!playerName) {
                alert('يرجى إدخال اسم اللاعب');
                return;
            }
            
            if (!roomIdInput) {
                alert('يرجى إدخال رقم الغرفة');
                return;
            }
            
            myPlayerName = playerName;
            roomId = roomIdInput;
            
            // إرسال طلب الانضمام إلى الغرفة
            socket.emit('joinRoom', {
                roomId: roomId,
                playerName: playerName
            });
        }
        
        // استقبال الأحداث من الخادم
        socket.on('joinedRoom', (data) => {
            console.log('انضم إلى الغرفة:', data);
            players = data.room.players;
            myPlayerNumber = data.player.number;
            
            // إظهار معلومات الغرفة
            showRoomInfo(data.room, data.player);
        });
        
        socket.on('playerJoined', (data) => {
            console.log('انضم لاعب جديد:', data);
            players = data.players;
            
            // تحديث معلومات الغرفة
            updateRoomInfo(data.players);
        });
        
        socket.on('roomFull', (data) => {
            alert('الغرفة ممتلئة بالفعل. يرجى اختيار غرفة أخرى.');
        });
        
        socket.on('gameReady', (data) => {
            console.log('اللعبة جاهزة:', data);
            
            // إخفاء واجهة إدخال الاسم
            document.getElementById('nameInputScreen').style.display = 'none';
            
            // إظهار اللعبة
            const gameContent = document.getElementById('gameContent');
            gameContent.style.display = 'block';
            
            // تهيئة اللعبة
            initializeGame(data.gameState, data.board);
        });
        
        socket.on('diceRolled', (data) => {
            console.log('تم رمي النرد:', data);
            diceElement.textContent = data.diceValue;
            
            if (data.player === myPlayerNumber) {
                statusElement.textContent = `رميت ${data.diceValue}`;
            } else {
                statusElement.textContent = `اللاعب ${data.player} رمى ${data.diceValue}`;
            }
        });
        
        socket.on('playerMoved', (data) => {
            console.log('تحرك اللاعب:', data);
            
            // تحديث مواقع اللاعبين
            playerPositions = data.gameState.playerPositions;
            updatePlayerPositions();
            
            // تحديث حالة اللعبة
            updateGameState(data.gameState);
        });
        
        socket.on('turnChanged', (data) => {
            console.log('تغير الدور:', data);
            currentPlayer = data.currentPlayer;
            
            if (currentPlayer === myPlayerNumber) {
                statusElement.textContent = 'دورك! ارم النرد';
                rollButton.disabled = false;
            } else {
                statusElement.textContent = `دور اللاعب ${currentPlayer}`;
                rollButton.disabled = true;
            }
        });
        
        socket.on('gameOver', (data) => {
            console.log('انتهت اللعبة:', data);
            gameOver = true;
            
            if (data.winner === myPlayerNumber) {
                statusElement.textContent = '🎉 مبروك! فزت! 🎉';
            } else {
                statusElement.textContent = `اللاعب ${data.winner} فاز!`;
            }
            
            rollButton.disabled = true;
        });
        
        socket.on('gameReset', (data) => {
            console.log('تم إعادة تعيين اللعبة:', data);
            
            // إعادة تعيين اللعبة
            resetGameState(data.gameState);
        });
        
        socket.on('playerLeft', (data) => {
            console.log('غادر لاعب:', data);
            players = data.players;
            
            if (players.length === 1) {
                statusElement.textContent = 'غادر اللاعب الآخر. انتظار لاعب جديد...';
                rollButton.disabled = true;
            }
        });
        
        // دالة إظهار معلومات الغرفة
        function showRoomInfo(room, player) {
            const nameInputScreen = document.getElementById('nameInputScreen');
            const inputContainer = nameInputScreen.querySelector('.input-container');
            
            inputContainer.innerHTML = `
                <h2>🎮 غرفة اللعب ${room.id}</h2>
                
                <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin: 20px 0;">
                    <h3>اللاعبون في الغرفة:</h3>
                    <div style="display: flex; justify-content: center; gap: 20px; margin: 20px 0;">
                        ${room.players.map(p => `
                            <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; min-width: 150px;">
                                <div>👤 ${p.name}</div>
                                <div>اللاعب ${p.number}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                ${room.players.length === 1 ? 
                    '<div style="font-size: 1.2em; margin: 20px 0; color: #FFD700;">⏳ في انتظار انضمام لاعب آخر...</div>' : 
                    '<div style="font-size: 1.2em; margin: 20px 0; color: #FFD700;">🎮 اللعبة جاهزة للبدء!</div>'
                }
                
                <button class="join-button" onclick="leaveRoom()">مغادرة الغرفة</button>
            `;
        }
        
        // دالة تحديث معلومات الغرفة
        function updateRoomInfo(playersList) {
            const playerListElement = document.querySelector('.player-list');
            if (playerListElement) {
                playerListElement.innerHTML = playersList.map(p => `
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; min-width: 150px;">
                        <div>👤 ${p.name}</div>
                        <div>اللاعب ${p.number}</div>
                    </div>
                `).join('');
            }
            
            const waitingMessage = document.querySelector('.waiting-message');
            if (waitingMessage) {
                waitingMessage.textContent = playersList.length === 1 ? 
                    '⏳ في انتظار انضمام لاعب آخر...' : 
                    '🎮 اللعبة جاهزة للبدء!';
            }
        }
        
        // دالة مغادرة الغرفة
        function leaveRoom() {
            socket.disconnect();
            showWelcome();
        }
        
        // دالة تهيئة اللعبة
        function initializeGame(gameState, boardData) {
            // إعادة تعيين حالة اللعبة
            currentPlayer = gameState.currentPlayer;
            playerPositions = gameState.playerPositions;
            gameOver = gameState.gameOver;
            
            // تهيئة اللوحة
            initializeBoard();
            generateSnakesAndLadders();
            updatePlayerPositions();
            
            // تحديث حالة اللعبة
            updateGameState(gameState);
            
            // تحديث حالة الأزرار
            if (currentPlayer === myPlayerNumber && !gameOver) {
                statusElement.textContent = 'دورك! ارم النرد';
                rollButton.disabled = false;
            } else if (!gameOver) {
                statusElement.textContent = `دور اللاعب ${currentPlayer}`;
                rollButton.disabled = true;
            }
        }
        
        // دالة إعادة تعيين حالة اللعبة
        function resetGameState(gameState) {
            currentPlayer = gameState.currentPlayer;
            playerPositions = gameState.playerPositions;
            gameOver = gameState.gameOver;
            
            // إعادة رسم اللوحة
            initializeBoard();
            generateSnakesAndLadders();
            updatePlayerPositions();
            
            // تحديث حالة اللعبة
            updateGameState(gameState);
            
            // تحديث حالة الأزرار
            if (currentPlayer === myPlayerNumber && !gameOver) {
                statusElement.textContent = 'دورك! ارم النرد';
                rollButton.disabled = false;
            } else if (!gameOver) {
                statusElement.textContent = `دور اللاعب ${currentPlayer}`;
                rollButton.disabled = true;
            }
        }
        
        // دالة تحديث حالة اللعبة
        function updateGameState(gameState) {
            currentPlayer = gameState.currentPlayer;
            playerPositions = gameState.playerPositions;
            gameOver = gameState.gameOver;
            
            if (gameOver) {
                rollButton.disabled = true;
            }
        }
        
        // دالة تحديث مواقع اللاعبين
        function updatePlayerPositions() {
            const startCell = document.getElementById('cell-1');
            const startRect = startCell.getBoundingClientRect();
            const boardRect = board.getBoundingClientRect();
            
            // تحريك اللاعب الأول
            if (playerPositions[0] > 1) {
                const cell1 = document.getElementById(`cell-${playerPositions[0]}`);
                const rect1 = cell1.getBoundingClientRect();
                const x1 = rect1.left - boardRect.left + rect1.width / 2;
                const y1 = rect1.top - boardRect.top + rect1.height / 2;
                player1Element.style.left = `${x1}px`;
                player1Element.style.top = `${y1}px`;
            } else {
                const startX = startRect.left - boardRect.left + startRect.width / 2;
                const startY = startRect.top - boardRect.top + startRect.height / 2;
                player1Element.style.left = `${startX}px`;
                player1Element.style.top = `${startY}px`;
            }
            
            // تحريك اللاعب الثاني
            if (playerPositions[1] > 1) {
                const cell2 = document.getElementById(`cell-${playerPositions[1]}`);
                const rect2 = cell2.getBoundingClientRect();
                const x2 = rect2.left - boardRect.left + rect2.width / 2;
                const y2 = rect2.top - boardRect.top + rect2.height / 2;
                player2Element.style.left = `${x2}px`;
                player2Element.style.top = `${y2}px`;
            } else {
                const startX = startRect.left - boardRect.left + startRect.width / 2;
                const startY = startRect.top - boardRect.top + startRect.height / 2;
                player2Element.style.left = `${startX}px`;
                player2Element.style.top = `${startY}px`;
            }
        }
        
        // تهيئة اللوحة
        function initializeBoard() {
            board.innerHTML = '';
            
            // إنشاء اللوحة بترتيب متعرج
            for (let row = 10; row >= 1; row--) {
                const tr = document.createElement('tr');
                
                const isReverseRow = row % 2 === 0;
                const colsOrder = isReverseRow ? 
                    Array.from({length: 10}, (_, i) => 10 - i) : 
                    Array.from({length: 10}, (_, i) => i + 1);
                
                for (const col of colsOrder) {
                    const cellNumber = (row - 1) * 10 + col;
                    const td = document.createElement('td');
                    td.textContent = cellNumber;
                    td.id = `cell-${cellNumber}`;
                    tr.appendChild(td);
                }
                
                board.appendChild(tr);
            }
        }
        
        // إعداد مستمعي الأحداث
        rollButton.addEventListener('click', () => {
            if (currentPlayer === myPlayerNumber && !gameOver) {
                socket.emit('rollDice');
                rollButton.disabled = true;
            }
        });
        
        resetButton.addEventListener('click', () => {
            socket.emit('resetGame');
        });
        
        // إضافة مستمع لضغط Enter في حقول الإدخال
        document.getElementById('playerName').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('roomId').focus();
            }
        });
        
        document.getElementById('roomId').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                joinRoom();
            }
        });
    </script>
</body>
 